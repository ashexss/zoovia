<mat-card>
    <mat-card-header>
        <mat-card-title>
            <div class="header-container">
                <h2>{{ isEditMode ? 'Editar Mascota' : 'Nueva Mascota' }}</h2>
                <button mat-icon-button (click)="onCancel()" matTooltip="Volver">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </mat-card-title>
    </mat-card-header>

    <mat-card-content>
        @if (loading) {
        <div class="loading-container">
            <mat-spinner diameter="50"></mat-spinner>
        </div>
        }

        @if (!loading) {
        <form [formGroup]="petForm" (ngSubmit)="onSubmit()" class="pet-form">
            <!-- Owner Selection -->
            <div class="form-section">
                <h3>Dueño</h3>

                <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>Seleccionar cliente</mat-label>
                    <mat-select formControlName="clientId">
                        @if (loadingClients) {
                        <mat-option disabled>Cargando clientes...</mat-option>
                        }
                        @for (client of clients; track client.id) {
                        <mat-option [value]="client.id">
                            {{ getClientDisplayName(client) }}
                        </mat-option>
                        }
                    </mat-select>
                    <mat-icon matPrefix>person</mat-icon>
                    @if (petForm.get('clientId')?.invalid && petForm.get('clientId')?.touched) {
                    <mat-error>{{ getErrorMessage('clientId') }}</mat-error>
                    }
                </mat-form-field>
            </div>

            <!-- Basic Information -->
            <div class="form-section">
                <h3>Información Básica</h3>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Nombre</mat-label>
                        <input matInput formControlName="name">
                        <mat-icon matPrefix>pets</mat-icon>
                        @if (petForm.get('name')?.invalid && petForm.get('name')?.touched) {
                        <mat-error>{{ getErrorMessage('name') }}</mat-error>
                        }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Especie</mat-label>
                        <mat-select formControlName="species">
                            @for (species of speciesOptions; track species.value) {
                            <mat-option [value]="species.value">{{ species.label }}</mat-option>
                            }
                        </mat-select>
                        @if (petForm.get('species')?.invalid && petForm.get('species')?.touched) {
                        <mat-error>{{ getErrorMessage('species') }}</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Raza</mat-label>
                        <input matInput formControlName="breed">
                        @if (petForm.get('breed')?.invalid && petForm.get('breed')?.touched) {
                        <mat-error>{{ getErrorMessage('breed') }}</mat-error>
                        }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Sexo</mat-label>
                        <mat-select formControlName="gender">
                            @for (gender of genderOptions; track gender.value) {
                            <mat-option [value]="gender.value">{{ gender.label }}</mat-option>
                            }
                        </mat-select>
                        @if (petForm.get('gender')?.invalid && petForm.get('gender')?.touched) {
                        <mat-error>{{ getErrorMessage('gender') }}</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Fecha de Nacimiento</mat-label>
                        <input matInput [matDatepicker]="picker" formControlName="birthDate">
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                        <mat-icon matPrefix>cake</mat-icon>
                        @if (petForm.get('birthDate')?.invalid && petForm.get('birthDate')?.touched) {
                        <mat-error>{{ getErrorMessage('birthDate') }}</mat-error>
                        }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Peso (kg)</mat-label>
                        <input matInput type="number" formControlName="weight" step="0.1">
                        <mat-icon matPrefix>monitor_weight</mat-icon>
                        @if (petForm.get('weight')?.invalid && petForm.get('weight')?.touched) {
                        <mat-error>{{ getErrorMessage('weight') }}</mat-error>
                        }
                    </mat-form-field>
                </div>
            </div>

            <!-- Additional Details -->
            <div class="form-section">
                <h3>Detalles Adicionales</h3>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Color</mat-label>
                        <input matInput formControlName="color">
                        <mat-icon matPrefix>palette</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Número de Microchip (opcional)</mat-label>
                        <input matInput formControlName="microchipNumber">
                        <mat-icon matPrefix>qr_code</mat-icon>
                    </mat-form-field>
                </div>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field full-width">
                        <mat-label>URL de Foto (opcional)</mat-label>
                        <input matInput formControlName="photo">
                        <mat-icon matPrefix>image</mat-icon>
                    </mat-form-field>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button mat-button type="button" (click)="onCancel()" [disabled]="saving">
                    Cancelar
                </button>
                <button mat-raised-button color="primary" type="submit" [disabled]="saving || petForm.invalid">
                    @if (saving) {
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    }
                    {{ isEditMode ? 'Actualizar' : 'Registrar' }} Mascota
                </button>
            </div>
        </form>
        }
    </mat-card-content>
</mat-card>