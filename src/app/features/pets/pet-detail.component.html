@if (loading) {
<div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando información de la mascota...</p>
</div>
}

@if (!loading && pet) {
<div class="pet-detail">

    <!-- Header -->
    <div class="detail-header">
        <button mat-icon-button (click)="goBack()" matTooltip="Volver">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="pet-avatar-wrapper">
            @if (pet.species === 'dog') {
            <img src="icons/icon-dog.png" alt="Perro" class="custom-pet-header-icon">
            } @else if (pet.species === 'cat') {
            <img src="icons/icon-cat.png" alt="Gato" class="custom-pet-header-icon">
            } @else {
            <div class="pet-avatar"><mat-icon>{{ getPetIcon(pet.species) }}</mat-icon></div>
            }
        </div>
        <div class="pet-title">
            <h1>{{ pet.name }}</h1>
            <div class="pet-meta">
                <span>{{ pet.species | titlecase }}</span>
                <span class="dot">·</span>
                <span>{{ pet.breed || 'Mestizo' }}</span>
                <span class="dot">·</span>
                <span>{{ getAge(pet.birthDate) }}</span>
            </div>
        </div>
        <button mat-raised-button color="primary" (click)="editPet()">
            <mat-icon>edit</mat-icon> Editar Mascota
        </button>
    </div>

    <!-- Tabs -->
    <mat-tab-group animationDuration="200ms">

        <!-- ── Datos de la Mascota ───────────────────────────────────────── -->
        <mat-tab label="Ficha Médica">
            <div class="tab-content two-col">

                <mat-card>
                    <mat-card-header>
                        <mat-icon mat-card-avatar>info</mat-icon>
                        <mat-card-title>Características</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="info-row">
                            <span class="label">Sexo</span>
                            <span class="value">{{ pet.gender === 'male' ? 'Macho' : 'Hembra' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Castrado</span>
                            <span class="value">{{ pet.isNeutered === 'yes' ? 'Sí' : (pet.isNeutered === 'no' ? 'No' :
                                'Desconocido/No cargado') }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Peso</span>
                            <span class="value">{{ pet.weight ? pet.weight + ' kg' : 'No registrado' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Color</span>
                            <span class="value">{{ pet.color || '-' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Nacimiento</span>
                            <span class="value">{{ formatDate(pet.birthDate) }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Microchip</span>
                            <span class="value">{{ pet.microchipNumber || 'No tiene' }}</span>
                        </div>
                    </mat-card-content>
                </mat-card>

                <mat-card>
                    <mat-card-header>
                        <mat-icon mat-card-avatar>person</mat-icon>
                        <mat-card-title>Propietario</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        @if (owner) {
                        <div class="owner-info">
                            <div class="owner-name">{{ owner.firstName }} {{ owner.lastName }}</div>
                            <div class="info-row no-border"><mat-icon>phone</mat-icon> {{ owner.phone }}</div>
                            <div class="info-row no-border"><mat-icon>email</mat-icon> {{ owner.email }}</div>
                            <button mat-stroked-button color="primary" class="mt-3" (click)="viewOwner()">
                                Ver perfil del cliente
                            </button>
                        </div>
                        } @else {
                        <p class="text-muted">No se pudo cargar la información del dueño.</p>
                        }
                    </mat-card-content>
                </mat-card>

            </div>
        </mat-tab>

        <!-- ── Historial Clínico ───────────────────────────────────────── -->
        <mat-tab [label]="'Consultas (' + consultations.length + ')'">
            <div class="tab-content">
                <div class="section-header">
                    <h3>Registro de Visitas Médicas</h3>
                    @if (hasActiveAppointment) {
                    <button mat-raised-button color="primary" (click)="newConsultation()">
                        <mat-icon>add</mat-icon> Nueva Consulta
                    </button>
                    } @else {
                    <div matTooltip="Debes iniciar la atención de su turno en la agenda para registrar una consulta"
                        matTooltipPosition="above">
                        <button mat-raised-button color="primary" disabled>
                            <mat-icon>add</mat-icon> Nueva Consulta
                        </button>
                    </div>
                    }
                </div>

                @if (loadingRecords) {
                <div class="loading-container small"><mat-spinner diameter="30"></mat-spinner></div>
                }

                @if (!loadingRecords && consultations.length === 0) {
                <div class="empty-state">
                    <mat-icon>medical_information</mat-icon>
                    <p>No hay consultas clínicas registradas para esta mascota.</p>
                    <button mat-stroked-button color="primary" (click)="newConsultation()">Registrar primera
                        consulta</button>
                </div>
                }

                <div class="records-list">
                    @for (record of consultations; track record.id) {
                    <mat-card class="record-card">
                        <mat-card-content>
                            <div class="record-header">
                                <div class="record-date">
                                    <mat-icon>event</mat-icon>
                                    {{ formatDate(record.date) }}
                                </div>
                                <span class="badge" [ngClass]="record.type">{{ record.type === 'consultation' ?
                                    'Consulta' : (record.type === 'surgery' ? 'Cirugía' : 'Control') }}</span>
                            </div>
                            <div class="record-body">
                                <strong>Diagnóstico / Tratam.:</strong>
                                <p>{{ record.diagnosisAndTreatment }}</p>
                                @if (record.notes) {
                                <strong>Notas:</strong>
                                <p>{{ record.notes }}</p>
                                }
                                @if (record.prescriptions && record.prescriptions.length > 0) {
                                <strong>Recetas:</strong>
                                <ul>
                                    @for (p of record.prescriptions; track p.medication) {
                                    <li>{{ p.medication }} ({{ p.dosage }} - {{ p.frequency }} - {{ p.duration }})</li>
                                    }
                                </ul>
                                }
                                @if (record.vaccines && record.vaccines.length > 0) {
                                <strong>Vacunas:</strong>
                                <ul>
                                    @for (vac of record.vaccines; track vac.name) {
                                    <li>{{ vac.name }} (Vence: {{ formatDate(vac.expirationDate) }})</li>
                                    }
                                </ul>
                                }
                                @if (record.deworming && record.deworming.length > 0) {
                                <strong>Desparasitación:</strong>
                                <ul>
                                    @for (dew of record.deworming; track dew.name) {
                                    <li>{{ dew.name }} ({{ dew.type === 'both' ? 'Interno y Externo' : (dew.type ===
                                        'internal' ? 'Interno' : 'Externo') }}) - Vence: {{
                                        formatDate(dew.expirationDate) }}</li>
                                    }
                                </ul>
                                }
                            </div>
                        </mat-card-content>
                    </mat-card>
                    }
                </div>
            </div>
        </mat-tab>

        <!-- ── Vacunas ───────────────────────────────────────── -->
        <mat-tab [label]="'Vacunas (' + vaccinations.length + ')'">
            <div class="tab-content">
                <div class="section-header">
                    <h3>Registro de Vacunación</h3>
                    @if (hasActiveAppointment) {
                    <button mat-raised-button color="primary" (click)="newConsultation()">
                        <mat-icon>add</mat-icon> Nueva Vacuna
                    </button>
                    } @else {
                    <div matTooltip="Debes iniciar la atención de su turno en la agenda para registrar una vacuna"
                        matTooltipPosition="above">
                        <button mat-raised-button color="primary" disabled>
                            <mat-icon>add</mat-icon> Nueva Vacuna
                        </button>
                    </div>
                    }
                </div>

                @if (!loadingRecords && vaccinations.length === 0) {
                <div class="empty-state">
                    <mat-icon>vaccines</mat-icon>
                    <p>Calendario de vacunación sin iniciar.</p>
                </div>
                }

                <div class="records-list">
                    @for (record of vaccinations; track record.id) {
                    <mat-card class="record-card">
                        <mat-card-content>
                            <div class="record-header">
                                <div class="record-date"><mat-icon>event</mat-icon>{{ formatDate(record.date) }}</div>
                                <span class="badge">Vacuna</span>
                            </div>
                            <div class="record-body">
                                @if (record.vaccines && record.vaccines.length > 0) {
                                <ul>
                                    @for (vac of record.vaccines; track vac.name) {
                                    <li><strong>{{ vac.name }}</strong> (Vence: {{ formatDate(vac.expirationDate) }})
                                    </li>
                                    }
                                </ul>
                                } @else {
                                <strong>Aplicación:</strong>
                                <p>{{ record.diagnosisAndTreatment || record.notes || 'Vacuna aplicada' }}</p>
                                }
                            </div>
                        </mat-card-content>
                    </mat-card>
                    }
                </div>
            </div>
        </mat-tab>

        <!-- ── Desparasitaciones ───────────────────────────────────────── -->
        <mat-tab [label]="'Desparasitaciones (' + dewormings.length + ')'">
            <div class="tab-content">
                <div class="section-header">
                    <h3>Registro de Desparasitación</h3>
                    @if (hasActiveAppointment) {
                    <button mat-raised-button color="primary" (click)="newConsultation()">
                        <mat-icon>add</mat-icon> Nueva Dosis
                    </button>
                    } @else {
                    <div matTooltip="Debes iniciar la atención de su turno en la agenda para registrar una desparasitación"
                        matTooltipPosition="above">
                        <button mat-raised-button color="primary" disabled>
                            <mat-icon>add</mat-icon> Nueva Dosis
                        </button>
                    </div>
                    }
                </div>

                @if (!loadingRecords && dewormings.length === 0) {
                <div class="empty-state">
                    <mat-icon>medication</mat-icon>
                    <p>No hay registro de desparasitaciones.</p>
                </div>
                }

                <div class="records-list">
                    @for (record of dewormings; track record.id) {
                    <mat-card class="record-card">
                        <mat-card-content>
                            <div class="record-header">
                                <div class="record-date"><mat-icon>event</mat-icon>{{ formatDate(record.date) }}</div>
                                <span class="badge">Parasitario</span>
                            </div>
                            <div class="record-body">
                                @if (record.deworming && record.deworming.length > 0) {
                                <ul>
                                    @for (dew of record.deworming; track dew.name) {
                                    <li>
                                        <strong>{{ dew.name }}</strong>
                                        <em>({{ dew.type === 'both' ? 'Interno y Externo' : (dew.type === 'internal' ?
                                            'Interno' : 'Externo') }})</em>
                                        - Vence: {{ formatDate(dew.expirationDate) }}
                                    </li>
                                    }
                                </ul>
                                } @else {
                                <strong>Producto Administrado:</strong>
                                <p>{{ record.diagnosisAndTreatment || record.notes || 'Producto administrado' }}</p>
                                }
                            </div>
                        </mat-card-content>
                    </mat-card>
                    }
                </div>
            </div>
        </mat-tab>

        <!-- ── Tratamientos ───────────────────────────────────────── -->
        <mat-tab [label]="'Tratamientos (' + treatments.length + ')'">
            <div class="tab-content">
                <div class="section-header">
                    <h3>Tratamientos Prolongados</h3>
                    @if (hasActiveAppointment) {
                    <button mat-raised-button color="primary" (click)="newConsultation()">
                        <mat-icon>add</mat-icon> Nuevo Tratamiento
                    </button>
                    } @else {
                    <div matTooltip="Debes iniciar la atención de su turno en la agenda para registrar un tratamiento"
                        matTooltipPosition="above">
                        <button mat-raised-button color="primary" disabled>
                            <mat-icon>add</mat-icon> Nuevo Tratamiento
                        </button>
                    </div>
                    }
                </div>

                @if (!loadingRecords && treatments.length === 0) {
                <div class="empty-state">
                    <mat-icon>healing</mat-icon>
                    <p>Mascota sin tratamientos crónicos o prolongados activos.</p>
                </div>
                }

                <div class="records-list">
                    @for (record of treatments; track record.id) {
                    <mat-card class="record-card">
                        <mat-card-content>
                            <div class="record-header">
                                <div class="record-date"><mat-icon>event</mat-icon>{{ formatDate(record.date) }}</div>
                                <span class="badge">Tratamiento</span>
                            </div>
                            <div class="record-body">
                                <strong>Indicación general:</strong>
                                <p>{{ record.diagnosisAndTreatment || record.notes }}</p>
                                @if (record.prescriptions && record.prescriptions.length > 0) {
                                <strong>Recetado:</strong>
                                <ul>
                                    @for (p of record.prescriptions; track p.medication) {
                                    <li>{{ p.medication }} ({{ p.dosage }} - {{ p.frequency }} - {{ p.duration }})</li>
                                    }
                                </ul>
                                }
                            </div>
                        </mat-card-content>
                    </mat-card>
                    }
                </div>
            </div>
        </mat-tab>

    </mat-tab-group>
</div>
}