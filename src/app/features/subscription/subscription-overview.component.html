<div class="subscription-page">

    @if (!veterinary || !subscription) {
    <div class="loading">
        <mat-spinner diameter="40"></mat-spinner>
    </div>
    } @else {
    <!-- Status Banner -->
    <div class="status-banner" [class.trial]="subscription.status === 'trial'">
        <mat-icon>{{ subscription.status === 'active' ? 'verified' : 'timer' }}</mat-icon>
        <span>{{ statusLabel }}</span>
    </div>

    <!-- Plan Summary Card -->
    <mat-card class="plan-card">
        <mat-card-header>
            <mat-icon mat-card-avatar>business</mat-icon>
            <mat-card-title>{{ veterinary.name }}</mat-card-title>
            <mat-card-subtitle>{{ getBusinessTypeLabel() }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <div class="plan-details">
                <div class="plan-info">
                    <span class="label">Plan actual</span>
                    <strong>{{ subscription.plan | titlecase }}</strong>
                </div>
                <div class="plan-info">
                    <span class="label">Facturación</span>
                    <strong>{{ subscription.billingCycle === 'monthly' ? 'Mensual' : 'Anual' }}</strong>
                </div>
                <div class="plan-info price">
                    <span class="label">Total mensual</span>
                    <strong class="price-value">${{ currentMonthlyPrice }} USD</strong>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Modules Marketplace -->
    <h3 class="section-title">
        <mat-icon>extension</mat-icon>
        Módulos disponibles
    </h3>

    <div class="modules-grid">
        @for (mod of availableModules(); track mod.key) {
        <mat-card class="module-card" [class.active]="isModuleActive(mod.key)">
            <div class="module-header">
                <div class="module-icon" [class.active]="isModuleActive(mod.key)">
                    <mat-icon>{{ mod.icon }}</mat-icon>
                </div>
                <div class="module-title">
                    <h4>{{ mod.name }}</h4>
                    <span class="module-price">+${{ mod.price }}/mes</span>
                </div>
                <mat-slide-toggle [checked]="isModuleActive(mod.key)" (change)="toggleModule(mod)" [disabled]="saving"
                    color="primary">
                </mat-slide-toggle>
            </div>
            <p class="module-description">{{ mod.description }}</p>
            <div class="module-status">
                <mat-icon>{{ isModuleActive(mod.key) ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                {{ isModuleActive(mod.key) ? 'Activo' : 'No activado' }}
            </div>
        </mat-card>
        }
    </div>

    <!-- Core Modules (informational, always included) -->
    <h3 class="section-title">
        <mat-icon>lock_open</mat-icon>
        Módulos incluidos en tu plan
    </h3>
    <div class="core-modules">
        @if (subscription.modules.clients) {
        <div class="core-chip"><mat-icon>people</mat-icon> Clientes</div>
        }
        @if (subscription.modules.pets) {
        <div class="core-chip"><mat-icon>pets</mat-icon> Mascotas</div>
        }
        @if (subscription.modules.medicalRecords) {
        <div class="core-chip"><mat-icon>medical_services</mat-icon> Historiales Médicos</div>
        }
        <div class="core-chip"><mat-icon>settings</mat-icon> Configuración</div>
    </div>

    } <!-- end @if -->
</div>