<div class="settings-container">
    <div class="settings-header">
        <h1>Configuraci√≥n</h1>
        <p>Administr√° la informaci√≥n y suscripci√≥n de tu veterinaria</p>
    </div>

    <mat-tab-group animationDuration="200ms" class="settings-tabs">

        <!-- TAB 1: General Configuration -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>settings</mat-icon>&nbsp;Perfil
            </ng-template>

            <div *ngIf="loading" class="loading-container">
                <mat-spinner></mat-spinner>
                <p>Cargando informaci√≥n...</p>
            </div>

            <!-- Permissions Error Message -->
            <div *ngIf="!loading && hasPermissionError" class="error-container">
                <mat-icon class="error-icon">lock</mat-icon>
                <h2>Error de Permisos de Firestore</h2>
                <p>No se pudo cargar la informaci√≥n de la veterinaria porque faltan las reglas de seguridad de
                    Firestore.</p>

                <div class="error-steps">
                    <h3>Pasos para solucionar:</h3>
                    <ol>
                        <li>Abr√≠ <a href="https://console.firebase.google.com/project/zoovia-50573/firestore/rules"
                                target="_blank">Firebase Console - Firestore Rules</a></li>
                        <li>Agreg√° las reglas de seguridad para la colecci√≥n <code>veterinaries</code></li>
                        <li>Public√° los cambios</li>
                        <li>Recarg√° esta p√°gina</li>
                    </ol>

                    <div class="code-example">
                        <h4>Reglas m√≠nimas necesarias:</h4>
                        <pre><code>match /veterinaries/&#123;vetId&#125; &#123;
  allow read, write: if request.auth != null;
&#125;</code></pre>
                    </div>

                    <p class="help-text">
                        <mat-icon>info</mat-icon>
                        Para m√°s detalles, consult√° la gu√≠a de configuraci√≥n completa que te compart√≠ anteriormente.
                    </p>
                </div>
            </div>

            <div *ngIf="!loading && veterinary" class="settings-content">

                <!-- General Information -->
                <mat-card class="settings-card">
                    <mat-card-header>
                        <mat-icon mat-card-avatar>business</mat-icon>
                        <mat-card-title>Informaci√≥n General</mat-card-title>
                        <mat-card-subtitle>Datos b√°sicos de la veterinaria</mat-card-subtitle>
                    </mat-card-header>

                    <mat-card-content>
                        <form [formGroup]="generalForm">
                            <!-- Logo Upload -->
                            <div class="logo-section">
                                <div class="logo-preview">
                                    <img *ngIf="logoPreview" [src]="logoPreview" alt="Logo">
                                    <mat-icon *ngIf="!logoPreview">add_photo_alternate</mat-icon>
                                </div>
                                <div class="logo-actions">
                                    <input type="file" #logoInput accept="image/*" (change)="onLogoSelected($event)"
                                        style="display: none">
                                    <button mat-raised-button color="primary" (click)="logoInput.click()">
                                        <mat-icon>upload</mat-icon>
                                        {{ logoPreview ? 'Cambiar Logo' : 'Subir Logo' }}
                                    </button>
                                    <p class="hint">Tama√±o m√°ximo: 2MB. Formatos: JPG, PNG</p>
                                </div>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Nombre de la Veterinaria</mat-label>
                                    <input matInput formControlName="name" placeholder="Ej: Veterinaria San Mart√≠n">
                                    <mat-icon matPrefix>business</mat-icon>
                                    <mat-error *ngIf="generalForm.get('name')?.hasError('required')">
                                        El nombre es requerido
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Tel√©fono</mat-label>
                                    <input matInput formControlName="phone" placeholder="+54 11 1234-5678">
                                    <mat-icon matPrefix>phone</mat-icon>
                                    <mat-error *ngIf="generalForm.get('phone')?.hasError('required')">
                                        El tel√©fono es requerido
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Email</mat-label>
                                    <input matInput type="email" formControlName="email"
                                        placeholder="contacto@veterinaria.com">
                                    <mat-icon matPrefix>email</mat-icon>
                                    <mat-error *ngIf="generalForm.get('email')?.hasError('required')">
                                        El email es requerido
                                    </mat-error>
                                    <mat-error *ngIf="generalForm.get('email')?.hasError('email')">
                                        Email inv√°lido
                                    </mat-error>
                                </mat-form-field>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>

                <!-- Address -->
                <mat-card class="settings-card">
                    <mat-card-header>
                        <mat-icon mat-card-avatar>location_on</mat-icon>
                        <mat-card-title>Direcci√≥n</mat-card-title>
                        <mat-card-subtitle>Ubicaci√≥n de la veterinaria</mat-card-subtitle>
                    </mat-card-header>

                    <mat-card-content>
                        <form [formGroup]="addressForm">
                            <div class="form-row">
                                <mat-form-field appearance="outline" class="full-width">
                                    <mat-label>Calle y N√∫mero</mat-label>
                                    <input matInput formControlName="street" placeholder="Av. San Mart√≠n 1234">
                                    <mat-icon matPrefix>home</mat-icon>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Ciudad</mat-label>
                                    <input matInput formControlName="city" placeholder="Buenos Aires">
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Provincia/Estado</mat-label>
                                    <input matInput formControlName="state" placeholder="Buenos Aires">
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>C√≥digo Postal</mat-label>
                                    <input matInput formControlName="zipCode" placeholder="1234">
                                </mat-form-field>

                                <mat-form-field appearance="outline">
                                    <mat-label>Pa√≠s</mat-label>
                                    <input matInput formControlName="country" placeholder="Argentina">
                                </mat-form-field>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>

                <!-- Save Button -->
                <div class="actions">
                    <button mat-raised-button color="primary" (click)="saveChanges()"
                        [disabled]="saving || uploadingLogo">
                        <mat-spinner *ngIf="saving || uploadingLogo" diameter="20"></mat-spinner>
                        <mat-icon *ngIf="!saving && !uploadingLogo">save</mat-icon>
                        {{ saving ? 'Guardando...' : 'Guardar Perfil' }}
                    </button>
                </div>

            </div> <!-- /.settings-content -->
        </mat-tab> <!-- end Perfil tab -->

        <!-- TAB 2: Rutina y Horarios -->
        <mat-tab *ngIf="veterinary">
            <ng-template mat-tab-label>
                <mat-icon>calendar_month</mat-icon>&nbsp;Agenda
            </ng-template>

            <div class="settings-content">
                <!-- Business Hours -->
                <mat-card class="settings-card">
                    <mat-card-header>
                        <mat-icon mat-card-avatar>schedule</mat-icon>
                        <mat-card-title>Horarios de Atenci√≥n</mat-card-title>
                        <mat-card-subtitle>Configura los horarios de la cl√≠nica</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                        <app-business-hours-editor [businessHours]="businessHours"
                            (hoursChange)="onBusinessHoursChange($event)">
                        </app-business-hours-editor>
                    </mat-card-content>
                </mat-card>

                <!-- Closed Dates (Feriados) -->
                <mat-card class="settings-card">
                    <mat-card-header>
                        <mat-icon mat-card-avatar>event_busy</mat-icon>
                        <mat-card-title>Fechas Cerradas (Feriados)</mat-card-title>
                        <mat-card-subtitle>D√≠as espec√≠ficos sin atenci√≥n regular</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                        <app-closed-dates-manager [closedDates]="closedDates"
                            (closedDatesChange)="onClosedDatesChange($event)">
                        </app-closed-dates-manager>
                    </mat-card-content>
                </mat-card>

                <!-- Vacation Periods -->
                <mat-card class="settings-card">
                    <mat-card-header>
                        <mat-icon mat-card-avatar>beach_access</mat-icon>
                        <mat-card-title>Vacaciones</mat-card-title>
                        <mat-card-subtitle>Rangos de fechas en los que la cl√≠nica estar√° cerrada</mat-card-subtitle>
                    </mat-card-header>
                    <mat-card-content>
                        <app-vacation-periods-manager [vacationPeriods]="vacationPeriods"
                            (vacationPeriodsChange)="onVacationPeriodsChange($event)">
                        </app-vacation-periods-manager>
                    </mat-card-content>
                </mat-card>

                <!-- Save Button -->
                <div class="actions">
                    <button mat-raised-button color="primary" (click)="saveChanges()" [disabled]="saving">
                        <mat-spinner *ngIf="saving" diameter="20"></mat-spinner>
                        <mat-icon *ngIf="!saving">save</mat-icon>
                        {{ saving ? 'Guardando...' : 'Guardar Agenda' }}
                    </button>
                </div>
            </div>
        </mat-tab>

        <!-- TAB 2: Loyalty Program -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>stars</mat-icon>&nbsp;Fidelizaci√≥n
            </ng-template>
            <div class="tab-content-pad">
                <form [formGroup]="loyaltyForm">

                    <!-- Enable toggle -->
                    <mat-card class="settings-card">
                        <mat-card-header>
                            <mat-icon mat-card-avatar>stars</mat-icon>
                            <mat-card-title>Programa de Puntos</mat-card-title>
                            <mat-card-subtitle>Premi√° a tus clientes frecuentes</mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                            <div class="loyalty-toggle-row">
                                <div>
                                    <strong>Activar programa de puntos</strong>
                                    <p class="loyalty-hint">Cuando est√° activo, los clientes acumulan puntos
                                        autom√°ticamente al finalizar cada consulta.</p>
                                </div>
                                <mat-slide-toggle formControlName="enabled" color="primary"></mat-slide-toggle>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Points per action -->
                    <mat-card class="settings-card">
                        <mat-card-header>
                            <mat-icon mat-card-avatar>add_circle</mat-icon>
                            <mat-card-title>Acumulaci√≥n de Puntos</mat-card-title>
                            <mat-card-subtitle>Cu√°ntos puntos se otorgan por cada acci√≥n</mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                            <div class="form-row loyalty-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Puntos por consulta</mat-label>
                                    <input matInput type="number" formControlName="pointsPerVisit" min="0">
                                    <mat-hint>pts por turno finalizado</mat-hint>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Puntos por peluquer√≠a</mat-label>
                                    <input matInput type="number" formControlName="pointsPerGrooming" min="0">
                                    <mat-hint>pts por servicio de grooming</mat-hint>
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>Puntos por $1 de compra</mat-label>
                                    <input matInput type="number" formControlName="pointsPerPurchasePeso" min="0">
                                    <mat-hint>pts por cada $1 en compras</mat-hint>
                                </mat-form-field>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Redemption -->
                    <mat-card class="settings-card">
                        <mat-card-header>
                            <mat-icon mat-card-avatar>redeem</mat-icon>
                            <mat-card-title>Canje</mat-card-title>
                            <mat-card-subtitle>Cu√°ntos puntos equivalen a $1 de descuento</mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                            <div class="form-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>Puntos necesarios para $1</mat-label>
                                    <input matInput type="number" formControlName="redemptionRate" min="1">
                                    <mat-hint>Ej: 100 pts = $1 de descuento</mat-hint>
                                </mat-form-field>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Tiers -->
                    <mat-card class="settings-card">
                        <mat-card-header>
                            <mat-icon mat-card-avatar>military_tech</mat-icon>
                            <mat-card-title>Niveles (Tiers)</mat-card-title>
                            <mat-card-subtitle>Puntos acumulados totales necesarios para alcanzar cada
                                nivel</mat-card-subtitle>
                        </mat-card-header>
                        <mat-card-content>
                            <div class="form-row loyalty-row">
                                <mat-form-field appearance="outline">
                                    <mat-label>ü•à Plata ‚Äî puntos m√≠nimos</mat-label>
                                    <input matInput type="number" formControlName="tierSilver" min="1">
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>ü•á Oro ‚Äî puntos m√≠nimos</mat-label>
                                    <input matInput type="number" formControlName="tierGold" min="1">
                                </mat-form-field>
                                <mat-form-field appearance="outline">
                                    <mat-label>üíé Platino ‚Äî puntos m√≠nimos</mat-label>
                                    <input matInput type="number" formControlName="tierPlatinum" min="1">
                                </mat-form-field>
                            </div>
                            <p class="loyalty-hint">ü•â Bronce siempre es el nivel inicial (0 puntos).</p>
                        </mat-card-content>
                    </mat-card>

                    <!-- Save button -->
                    <div class="save-section">
                        <button mat-raised-button color="primary" (click)="saveChanges()"
                            [disabled]="saving || loyaltyForm.invalid">
                            @if (saving) { <mat-spinner diameter="20"></mat-spinner> }
                            @else { <mat-icon>save</mat-icon> }
                            Guardar Configuraci√≥n de Fidelizaci√≥n
                        </button>
                    </div>

                </form>
            </div>
        </mat-tab>

        <!-- TAB 3: Subscription -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>rocket_launch</mat-icon>&nbsp;Suscripci√≥n
            </ng-template>
            <div class="tab-content-pad">
                <app-subscription-overview></app-subscription-overview>
            </div>
        </mat-tab>

    </mat-tab-group>
</div>