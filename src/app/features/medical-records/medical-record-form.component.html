<mat-card>
    <mat-card-header>
        <mat-card-title>
            <div class="header-container">
                <h2>{{ isEditMode ? 'Editar Registro Médico' : 'Nuevo Registro Médico' }}</h2>
                <button mat-icon-button (click)="onCancel()" matTooltip="Volver">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </mat-card-title>
    </mat-card-header>

    <mat-card-content>
        @if (loading) {
        <div class="loading-container">
            <mat-spinner diameter="50"></mat-spinner>
        </div>
        }

        @if (!loading) {
        <form [formGroup]="recordForm" (ngSubmit)="onSubmit()" class="record-form">
            <!-- Patient Selection -->
            <div class="form-section">
                <h3>Paciente</h3>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Cliente</mat-label>
                        <mat-select formControlName="clientId">
                            @if (loadingData) {
                            <mat-option disabled>Cargando clientes...</mat-option>
                            }
                            @for (client of clients; track client.id) {
                            <mat-option [value]="client.id">
                                {{ getClientDisplayName(client) }}
                            </mat-option>
                            }
                        </mat-select>
                        <mat-icon matPrefix>person</mat-icon>
                        @if (recordForm.get('clientId')?.invalid && recordForm.get('clientId')?.touched) {
                        <mat-error>{{ getErrorMessage('clientId') }}</mat-error>
                        }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Mascota</mat-label>
                        <mat-select formControlName="petId">
                            @if (filteredPets.length === 0 && recordForm.get('clientId')?.value) {
                            <mat-option disabled>Este cliente no tiene mascotas</mat-option>
                            }
                            @for (pet of filteredPets; track pet.id) {
                            <mat-option [value]="pet.id">
                                {{ getPetDisplayName(pet) }}
                            </mat-option>
                            }
                        </mat-select>
                        <mat-icon matPrefix>pets</mat-icon>
                        @if (recordForm.get('petId')?.invalid && recordForm.get('petId')?.touched) {
                        <mat-error>{{ getErrorMessage('petId') }}</mat-error>
                        }
                    </mat-form-field>
                </div>
            </div>

            <!-- Record Information -->
            <div class="form-section">
                <h3>Información del Registro</h3>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Fecha</mat-label>
                        <input matInput [matDatepicker]="picker" formControlName="date">
                        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                        <mat-icon matPrefix>event</mat-icon>
                        @if (recordForm.get('date')?.invalid && recordForm.get('date')?.touched) {
                        <mat-error>{{ getErrorMessage('date') }}</mat-error>
                        }
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                        <mat-label>Tipo de Consulta</mat-label>
                        <mat-select formControlName="type">
                            @for (type of recordTypes; track type.value) {
                            <mat-option [value]="type.value">{{ type.label }}</mat-option>
                            }
                        </mat-select>
                        <mat-icon matPrefix>medical_services</mat-icon>
                        @if (recordForm.get('type')?.invalid && recordForm.get('type')?.touched) {
                        <mat-error>{{ getErrorMessage('type') }}</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field full-width">
                        <mat-label>Diagnóstico y Tratamiento</mat-label>
                        <textarea matInput formControlName="diagnosisAndTreatment" rows="4"></textarea>
                        <mat-icon matPrefix>description</mat-icon>
                        @if (recordForm.get('diagnosisAndTreatment')?.invalid &&
                        recordForm.get('diagnosisAndTreatment')?.touched) {
                        <mat-error>{{ getErrorMessage('diagnosisAndTreatment') }}</mat-error>
                        }
                    </mat-form-field>
                </div>

                <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field full-width">
                        <mat-label>Notas Adicionales (opcional)</mat-label>
                        <textarea matInput formControlName="notes" rows="2"></textarea>
                        <mat-icon matPrefix>note</mat-icon>
                    </mat-form-field>
                </div>
            </div>

            <!-- Vaccines -->
            <div class="form-section">
                <div class="section-header">
                    <h3>Vacunas</h3>
                    <button mat-raised-button type="button" color="accent" (click)="addVaccine()">
                        <mat-icon>add</mat-icon>
                        Agregar Vacuna
                    </button>
                </div>

                @if (vaccines.length === 0) {
                <p class="no-prescriptions">Vaya, no hay vacunas en este registro. Haga clic en "Agregar Vacuna" para
                    añadir una.</p>
                }

                @for (vaccine of vaccines.controls; track $index; let i = $index) {
                <div class="prescription-card" [formGroup]="$any(vaccine)">
                    <div class="prescription-header">
                        <h4>Vacuna {{ i + 1 }}</h4>
                        <button mat-icon-button type="button" color="warn" (click)="removeVaccine(i)"
                            matTooltip="Eliminar">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Nombre de vacuna</mat-label>
                            <input matInput formControlName="name">
                            <mat-icon matPrefix>vaccines</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Fecha de vencimiento</mat-label>
                            <input matInput [matDatepicker]="vacPicker" formControlName="expirationDate">
                            <mat-datepicker-toggle matIconSuffix [for]="vacPicker"></mat-datepicker-toggle>
                            <mat-datepicker #vacPicker></mat-datepicker>
                            <mat-icon matPrefix>event</mat-icon>
                        </mat-form-field>
                    </div>
                </div>
                }
            </div>

            <!-- Deworming -->
            <div class="form-section">
                <div class="section-header">
                    <h3>Desparasitaciones</h3>
                    <button mat-raised-button type="button" color="accent" (click)="addDeworming()">
                        <mat-icon>add</mat-icon>
                        Agregar Desparasitante
                    </button>
                </div>

                @if (deworming.length === 0) {
                <p class="no-prescriptions">Vaya, no hay desparasitantes en este registro. Haga clic para añadir uno.
                </p>
                }

                @for (deworm of deworming.controls; track $index; let i = $index) {
                <div class="prescription-card" [formGroup]="$any(deworm)">
                    <div class="prescription-header">
                        <h4>Desparasitante {{ i + 1 }}</h4>
                        <button mat-icon-button type="button" color="warn" (click)="removeDeworming(i)"
                            matTooltip="Eliminar">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Nombre del producto</mat-label>
                            <input matInput formControlName="name">
                            <mat-icon matPrefix>medication</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Tipo</mat-label>
                            <mat-select formControlName="type">
                                <mat-option value="internal">Interno</mat-option>
                                <mat-option value="external">Externo</mat-option>
                                <mat-option value="both">Ambos</mat-option>
                            </mat-select>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Fecha de vencimiento</mat-label>
                            <input matInput [matDatepicker]="dewPicker" formControlName="expirationDate">
                            <mat-datepicker-toggle matIconSuffix [for]="dewPicker"></mat-datepicker-toggle>
                            <mat-datepicker #dewPicker></mat-datepicker>
                            <mat-icon matPrefix>event</mat-icon>
                        </mat-form-field>
                    </div>
                </div>
                }
            </div>

            <!-- Prescriptions -->
            <div class="form-section">
                <div class="section-header">
                    <h3>Prescripciones</h3>
                    <button mat-raised-button type="button" color="accent" (click)="addPrescription()">
                        <mat-icon>add</mat-icon>
                        Agregar Medicamento
                    </button>
                </div>

                @if (prescriptions.length === 0) {
                <p class="no-prescriptions">No hay prescripciones. Haga clic en "Agregar Medicamento" para añadir una.
                </p>
                }

                @for (prescription of prescriptions.controls; track $index; let i = $index) {
                <div class="prescription-card" [formGroup]="$any(prescription)">
                    <div class="prescription-header">
                        <h4>Medicamento {{ i + 1 }}</h4>
                        <button mat-icon-button type="button" color="warn" (click)="removePrescription(i)"
                            matTooltip="Eliminar">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Medicamento</mat-label>
                            <input matInput formControlName="medication">
                            <mat-icon matPrefix>medication</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Dosis</mat-label>
                            <input matInput formControlName="dosage">
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Frecuencia</mat-label>
                            <input matInput formControlName="frequency">
                            <mat-icon matPrefix>schedule</mat-icon>
                        </mat-form-field>

                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Duración</mat-label>
                            <input matInput formControlName="duration">
                            <mat-icon matPrefix>calendar_today</mat-icon>
                        </mat-form-field>
                    </div>

                    <div class="form-row">
                        <mat-form-field appearance="outline" class="form-field">
                            <mat-label>Precio (opcional)</mat-label>
                            <input matInput type="number" formControlName="price" step="0.01">
                            <mat-icon matPrefix>attach_money</mat-icon>
                        </mat-form-field>
                    </div>

                    @if (i < prescriptions.length - 1) { <mat-divider></mat-divider>
                        }
                </div>
                }

                @if (prescriptions.length > 0) {
                <div class="total-cost">
                    <strong>Total Medicamentos:</strong>
                    <span class="cost-amount">${{ getTotalCost().toFixed(2) }}</span>
                </div>
                }
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button mat-button type="button" (click)="onCancel()" [disabled]="saving">
                    Cancelar
                </button>
                <button mat-raised-button color="primary" type="submit" [disabled]="saving || recordForm.invalid">
                    @if (saving) {
                    <mat-spinner diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                    }
                    {{ isEditMode ? 'Actualizar' : 'Guardar' }} Registro
                </button>
            </div>
        </form>
        }
    </mat-card-content>
</mat-card>